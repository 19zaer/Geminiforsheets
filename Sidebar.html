<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Gemini: API key & defaults</title>
  <style>
    body { font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; padding:12px; }
    label { display:block; margin:10px 0 4px; font-weight:600; }
    input, select { width:100%; padding:8px; box-sizing:border-box; }
    button { margin-top:12px; padding:8px 12px; cursor:pointer; }
    small { color:#555; display:block; margin-top:8px; }
    .row { display:flex; gap:8px; }
    .row > div { flex:1; }
    .status { margin-top:10px; min-height:1.25em; }
    .ok { color:green; }
    .err { color:#c62828; }
  </style>
</head>
<body>
  <h2>Gemini API key & defaults</h2>

  <label for="key">API key</label>
  <input id="key" type="password" placeholder="AI Studio API key" autocomplete="off" />

  <h3 style="margin-top:16px;">Defaults</h3>

  <label for="model">Model</label>
  <select id="model">
    <option>gemini-2.5-flash</option>
    <option>gemini-2.5-pro</option>
    <option>gemini-2.5-flash-lite</option>
    <option>gemini-2.0-flash</option>
  </select>

  <div class="row">
    <div>
      <label for="temp">Temperature</label>
      <input id="temp" type="number" step="0.1" value="0.2" min="0" max="1" />
    </div>
    <div>
      <label for="tokens">Max output tokens</label>
      <input id="tokens" type="number" value="1024" min="1" />
    </div>
  </div>

  <label>
    <input id="search" type="checkbox" checked>
    Enable Google Search grounding (adds citations)
  </label>

  <!-- Save + status -->
  <button id="saveBtn" type="button">Save</button>
  <div id="status-message" class="status" role="status" aria-live="polite"></div>
  <small>Your key is stored in Script Properties. Defaults are stored per-user.</small>

  <!-- Test connection UI -->
  <button id="testBtn" type="button" style="margin-top:8px;">Test connection</button>
  <div id="test-status" style="margin-top:8px; min-height:1.25em;"></div>

  <script>
    const $ = id => document.getElementById(id);
    const statusEl = $('status-message');
    const saveBtn = $('saveBtn');
    const testBtn = $('testBtn');
    const testStatus = $('test-status');

    function setStatus(msg, ok=false) {
      statusEl.textContent = msg || '';
      statusEl.className = 'status ' + (ok ? 'ok' : msg ? 'err' : '');
    }
    function setTest(msg, ok=false){
      testStatus.textContent = msg || '';
      testStatus.style.color = ok ? 'green' : '#c62828';
    }

    // Promise-wrapped, explicit server calls
    function saveApiKey(key) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .saveGeminiApiKey_(key);
      });
    }
    function saveDefaults(defaultsObj) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .saveDefaults_(JSON.stringify(defaultsObj));
      });
    }

    async function saveAll() {
      saveBtn.disabled = true;
      setStatus('Saving…');

      const defaults = {
        model: $('model').value,
        temperature: Number($('temp').value || 0.2),
        maxOutputTokens: Number($('tokens').value || 1024),
        search: $('search').checked
      };
      const key = $('key').value.trim();

      try {
        if (key) await saveApiKey(key);
        await saveDefaults(defaults);
        setStatus('✅ Saved successfully!', true);
      } catch (e) {
        setStatus('❌ Error: ' + (e && e.message ? e.message : e));
      } finally {
        saveBtn.disabled = false;
        setTimeout(() => setStatus(''), 3000);
      }
    }

    // Wire up buttons (this was missing)
    saveBtn.addEventListener('click', saveAll);
    testBtn.addEventListener('click', () => {
      testBtn.disabled = true;
      setTest('Testing…');
      google.script.run
        .withSuccessHandler(res => { setTest('✅ ' + res, true); testBtn.disabled = false; })
        .withFailureHandler(err => { setTest('❌ ' + (err && err.message ? err.message : err)); testBtn.disabled = false; })
        .ping_(); // calls ping_() in Code.gs
    });
  </script>
</body>
</html>
